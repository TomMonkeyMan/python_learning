// src/App.jsx
import { useState, useEffect, useRef } from 'react';
import Cookies from 'js-cookie';
import './App.css';

// ğŸ‘‡ è®¾ç½®ä½ çš„å…±äº«å¯†ç ï¼ˆå®é™…éƒ¨ç½²æ—¶å»ºè®®é€šè¿‡ç¯å¢ƒå˜é‡æ³¨å…¥ï¼Œä½†æœ¬åœ° demo å¯å†™æ­»ï¼‰
const SHARED_PASSWORD = 'xbzmb'; // â† æ”¹æˆä½ ä»¬çš„ç§˜å¯†å¯†ç ï¼

function App() {
  const [view, setView] = useState('password'); // 'password' | 'login' | 'chat'
  const [password, setPassword] = useState('');
  const [passwordError, setPasswordError] = useState('');
  const [nickname, setNickname] = useState('');
  const [messages, setMessages] = useState([]);
  const [inputText, setInputText] = useState('');
  const [onlineUsers, setOnlineUsers] = useState([]);
  const wsRef = useRef(null);
  const messagesEndRef = useRef(null);

  // æ£€æŸ¥ Cookie æ˜¯å¦å·²è®¤è¯
  useEffect(() => {
    const auth = Cookies.get('chat_auth');
    if (auth === 'true') {
      setView('login'); // è·³è¿‡å¯†ç é¡µ
    }
  }, []);

  // è‡ªåŠ¨æ»šåŠ¨
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages]);

  // éªŒè¯å¯†ç 
  const handlePasswordSubmit = () => {
    if (password === SHARED_PASSWORD) {
      Cookies.set('chat_auth', 'true', { expires: 30 }); // 30å¤©å…å¯†
      setView('login');
      setPasswordError('');
    } else {
      setPasswordError('å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•');
      setPassword('');
    }
  };

  const handlePasswordKeyPress = (e) => {
    if (e.key === 'Enter') handlePasswordSubmit();
  };

  // è¿æ¥ WebSocketï¼ˆåŒä¹‹å‰ï¼‰
  const connect = (nick) => {
    setNickname(nick);
    setView('chat');
  
    //const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
    //const host =
    //  window.location.hostname === 'localhost'
    //    ? 'localhost:8099'
    //    : window.location.host;
    //const ws = new WebSocket(`${protocol}://${host}/ws`);

    const getWebSocketUrl = () => {
      const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
      // ä½¿ç”¨å½“å‰é¡µé¢è·¯å¾„çš„å‰ç¼€ + /ws
      const basePath = '/xbzchat'; // â† å’Œ Nginx location ä¸€è‡´
      return `${protocol}://${window.location.host}${basePath}/ws`;
    };

    const ws = new WebSocket(getWebSocketUrl());
    wsRef.current = ws;

    ws.onopen = () => {
      ws.send(JSON.stringify({ nickname: nick }));
    };

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      if (data.type === 'online_users') {
        setOnlineUsers(data.users);
      } else if (['message', 'system', 'history'].includes(data.type)) {
        setMessages((prev) => [...prev, data]);
      }
    };

    ws.onclose = () => {
      alert('è¿æ¥æ–­å¼€ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚');
    };
  };

  const sendMessage = () => {
    if (!inputText.trim() || !wsRef.current) return;
    wsRef.current.send(JSON.stringify({ content: inputText.trim() }));
    setInputText('');
  };

  const handleKeyPress = (e) => {
    if (e.key === 'Enter') sendMessage();
  };

  // æ¸…ç† WebSocket
  useEffect(() => {
    return () => {
      if (wsRef.current) wsRef.current.close();
    };
  }, []);

  // ===== æ¸²æŸ“ä¸åŒè§†å›¾ =====

  if (view === 'password') {
    return (
      <div className="password-container">
        <h1>ğŸ”’ ç§å¯†èŠå¤©å®¤</h1>
        <p>è¯·è¾“å…¥å…±äº«å¯†ç ï¼š</p>
        <input
          type="password"
          value={password}
          onChange={(e) => setPassword(e.target.value)}
          onKeyPress={handlePasswordKeyPress}
          placeholder="å¯†ç "
          autoFocus
        />
        {passwordError && <p className="error">{passwordError}</p>}
        <button onClick={handlePasswordSubmit} disabled={!password}>
          ç¡®è®¤
        </button>
      </div>
    );
  }

  if (view === 'login') {
    return (
      <div className="login-container">
        <h1>ğŸ’• é€‰æ‹©ä½ çš„èº«ä»½</h1>
        <button onClick={() => connect('tom')}>æˆ‘æ˜¯ Tom</button>
        <button onClick={() => connect('é¦™å•µçŒª')}>æˆ‘æ˜¯ é¦™å•µçŒª</button>
        <button
          className="logout-btn"
          onClick={() => {
            Cookies.remove('chat_auth');
            setView('password');
          }}
        >
          åˆ‡æ¢è´¦å· / é€€å‡º
        </button>
      </div>
    );
  }

  return (
    <div className="chat-container">
      <header>
        <h2>ç§å¯†èŠå¤©ä¸­ ğŸ’¬</h2>
        <div className="online">åœ¨çº¿ï¼š{onlineUsers.join(', ') || 'åŠ è½½ä¸­...'}</div>
      </header>

      <div className="messages">
        {messages.map((msg, i) => (
          <div
            key={i}
            className={`msg ${
              msg.type === 'system'
                ? 'system'
                : msg.nickname === nickname
                ? 'me'
                : 'other'
            }`}
          >
            {msg.type === 'system' ? (
              <em>{msg.content}</em>
            ) : (
              <>
                <strong>{msg.nickname}:</strong> {msg.content}
              </>
            )}
          </div>
        ))}
        <div ref={messagesEndRef} />
      </div>

      <div className="input-area">
        <input
          value={inputText}
          onChange={(e) => setInputText(e.target.value)}
          onKeyPress={handleKeyPress}
          placeholder="è¾“å…¥æ¶ˆæ¯..."
          maxLength={200}
        />
        <button onClick={sendMessage} disabled={!inputText.trim()}>
          å‘é€
        </button>
      </div>
    </div>
  );
}

export default App;
